<%- include('../header') %>
<%- include('../left-sidebar') %>

<div class="page">
  <div class="container-fluid">
    <div class="d-flex justify-content-between">
      <h1 class="commanHeading">In-Progress Crons</h1>
      <br />
    </div>

    <!-- Regular, Secondary, and Express Crons Table -->
    <div class="card">
      <div class="body table-responsive">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Regular, Secondary & Express Cron Statuses:</h5>
          <button type="button" class="btn btn-primary btn-sm" id="refreshRegularCrons">
            <i class="ti-reload"></i> Refresh
          </button>
        </div>
        <hr />
        <table
          id="regularCronsTable"
          class="table table-striped table-bordered"
          style="width: 100%"
        >
          <thead>
            <tr>
              <th>Sl No.</th>
              <th>Date Time</th>
              <th>Object Id</th>
              <th>Cron Group</th>
              <th>Eligible Products</th>
              <th>Products Completed</th>
              <th>Cron Status</th>
            </tr>
          </thead>
          <tbody>
          <% if(cronStatus && cronStatus.length==0) { %>
            <tr>
              <td colspan="7" class="text-center" style="color: brown">No In-Progress Crons found.</td>
            </tr>
          <% } else if(cronStatus.length>0){
          cronStatus.forEach(function(cron,idx){ %>
            <tr>
              <td><%= idx+1 %></td>
              <td><%= cron.cronTime %></td>
              <td><%= cron.keyGenId %></td>
              <td><%= cron.cronName %></td>
              <td><%= cron.maximumProductCount %></td>
              <td><%= cron.productsCount %></td>
              <td>
                <% if(cron.status=="Complete" ){ %>
                <span style="color: green"><b> <%=cron.status %> </b></span>
                <% }else{%>
                <span style="color: orangered"><b> <%= cron.status %> </b></span>
                <%}%>
              </td>
            </tr>
          <%});}%>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Scrape Only Crons Table -->
    <div class="card">
      <div class="body table-responsive">
        <div class="d-flex justify-content-between align-items-center">
          <h5>DataOnly Cron Statuses:</h5>
          <button type="button" class="btn btn-primary btn-sm" id="refreshScrapeCrons">
            <i class="ti-reload"></i> Refresh
          </button>
        </div>
        <hr />
        <table
          id="scrapeCronsTable"
          class="table table-striped table-bordered"
          style="width: 100%; display: none;"
        >
          <thead>
            <tr>
              <th>Sl No.</th>
              <th>Date Time</th>
              <th>Object Id</th>
              <th>Cron Group</th>
              <th>Eligible Products</th>
              <th>Products Completed</th>
              <th>Cron Status</th>
            </tr>
          </thead>
          <tbody id="scrapeCronsBody">
            <tr>
              <td colspan="7" class="text-center">Click "Refresh" to load scrape-only crons</td>
            </tr>
          </tbody>
        </table>
        <div id="scrapeLoadingMessage" style="display: none;" class="text-center p-3">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading scrape-only crons...
        </div>
        <div id="scrapeInitialMessage" class="text-center p-3">
          Click "Refresh" to load scrape-only crons
        </div>
      </div>
    </div>
  </div>
</div>

<%- include("../footer"); %>

<script src="/javascripts/dashboard.js"></script>
<script>
  $(document).ready(function() {
    $('#refreshRegularCrons').on('click', function() {
      loadRegularCrons();
    });
scrape
    $('#refreshScrapeCrons').on('click', function() {
      loadScrapeCrons();
    });

    function loadRegularCrons() {
      $('#refreshRegularCrons').prop('disabled', true);

      $.ajax({
        url: '/dashboard/getInProgressRegularCrons',
        method: 'GET',
        success: function(response) {
          if (response.status && response.cronStatus) {
            displayRegularCrons(response.cronStatus);
          } else {
            displayRegularCrons([]);
          }

          $('#refreshRegularCrons').prop('disabled', false);
        },
        error: function(error) {
          console.error('Error loading regular crons:', error);
          alert('Error loading regular crons. Please try again.');
          $('#refreshRegularCrons').prop('disabled', false);
        }
      });
    }

    function displayRegularCrons(crons) {
      const tbody = $('#regularCronsTable tbody');
      tbody.empty();

      if (crons.length === 0) {
        tbody.append(
          '<tr><td colspan="7" class="text-center" style="color: brown">No In-Progress Crons found.</td></tr>'
        );
      } else {
        crons.forEach(function(cron, idx) {
          const statusColor = cron.status === 'Complete' ? 'green' : 'orangered';
          const row = `
            <tr>
              <td>${idx + 1}</td>
              <td>${cron.cronTime}</td>
              <td>${cron.keyGenId}</td>
              <td>${cron.cronName}</td>
              <td>${cron.maximumProductCount}</td>
              <td>${cron.productsCount}</td>
              <td>
                <span style="color: ${statusColor}"><b>${cron.status || ''}</b></span>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      }
    }

    function loadScrapeCrons() {
      $('#scrapeInitialMessage').hide();
      $('#scrapeCronsTable').hide();
      $('#scrapeLoadingMessage').show();
      $('#refreshScrapeCrons').prop('disabled', true);

      $.ajax({
        url: '/dashboard/getInProgressScrapeCrons',
        method: 'GET',
        success: function(response) {
          $('#scrapeLoadingMessage').hide();

          if (response.status && response.scrapeCronStatus) {
            displayScrapeCrons(response.scrapeCronStatus);
          } else {
            displayScrapeCrons([]);
          }

          $('#refreshScrapeCrons').prop('disabled', false);
        },
        error: function(error) {
          console.error('Error loading scrape crons:', error);
          $('#scrapeLoadingMessage').hide();
          $('#scrapeInitialMessage').text('Error loading scrape-only crons. Please try again.').show();
          $('#refreshScrapeCrons').prop('disabled', false);
        }
      });
    }

    function displayScrapeCrons(scrapeCrons) {
      const tbody = $('#scrapeCronsBody');
      tbody.empty();

      if (scrapeCrons.length === 0) {
        tbody.append(
          '<tr><td colspan="7" class="text-center" style="color: brown">No In-Progress Scrape-Only Crons found.</td></tr>'
        );
      } else {
        scrapeCrons.forEach(function(cron, idx) {
          const statusColor = cron.status === 'Complete' ? 'green' : 'orangered';
          const row = `
            <tr>
              <td>${idx + 1}</td>
              <td>${cron.cronTime}</td>
              <td>${cron.keyGenId}</td>
              <td>${cron.cronName}</td>
              <td>${cron.eligibleCount}</td>
              <td>${cron.productsCompleted}</td>
              <td>
                <span style="color: ${statusColor}"><b>${cron.status || ''}</b></span>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      $('#scrapeCronsTable').show();
    }
  });
</script>
