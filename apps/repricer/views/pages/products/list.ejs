<%- include('../header') %>
<%- include('../left-sidebar') %>

<% let pgno=pageNumber + 1; let upVal=0, lowVal=0 ; const pages=new
Array(totalPages).fill(null).map((v, i)=> i); if (pageNumber <= 2) { upVal=0;
lowVal=5 } else if (pageNumber>= (totalPages - 3)) { upVal = totalPages - 5;
lowVal = totalPages } else { upVal = pageNumber - 2; lowVal = pageNumber + 3 }
%>

<div class="page">
  <div class="container-fluid">
    <div class="d-flex justify-content-between">
      <h1 class="commanHeading">Items</h1>
      <div>
        (
        <%= (pageNumber * pageSize) + 1 %>
        -
        <%= Math.min((pageNumber * pageSize) +
                                        pageSize,totalDocs) %>
        /
        <%= totalDocs %>
        )
      </div>
      <div class="d-flex">
        <% if (tags==='' ) { %>
        <a href="/masteritem/runAllCron" class="btn btn-success mx-1"
          ><i class="fa-solid fa-play"></i> Run Cron</a
        >
        <% } else { %>
        <form method="POST" id="" action="/productV2/runManualCron">
          <% items.forEach(item=> { %>
          <input
            type="hidden"
            class="form-control"
            id="mpIds"
            name="mpIds"
            value="<%= item.mpid %>"
          />
          <% }); %>
          <button type="submit" class="btn btn-warning text-white mx-1">
            <i class="fa-solid fa-play"></i> Manual Scrape
          </button>
        </form>
        <form
          method="POST"
          id="form_update_max"
          action="masteritem/updateAllToMax"
        >
          <% items.forEach(item=> { %>
          <input
            type="hidden"
            class="form-control"
            id="mpIds_max_<%= item.mpid %>"
            name="mpIds_max_<%= item.mpid %>"
            value="<%= item.mpid %>"
          />
          <% }); %>
          <button type="submit" class="btn btn-success text-white mx-1">
            <i class="fa-solid fa-pen-clip"></i> Update to Max
          </button>
        </form>
        <% } %>
        <a href="/masteritem/resetCron" class="btn btn-dark mx-1"
          ><i class="fa-solid fa-arrow-rotate-right"></i> Reset</a
        >
        <a href="/productV2/add" class="btn btn-primary mx-1"
          ><i class="fa-solid fa-plus"></i> Add Item</a
        >

        <button
          type="button"
          class="btn btn-primary mx-1"
          data-toggle="modal"
          data-target="#exampleModal"
        >
          <i class="fa-solid fa-file-arrow-up"></i>
          Import Excel
        </button>

        <% if(items && items.length !=0){ %>
        <form method="POST" id="download_excel" action="download_excel">
          <button type="submit" class="btn btn-primary mx-1">
            <i class="fa-solid fa-file-arrow-down"></i> Export List
          </button>
        </form>
        <% } %>
        &nbsp;
        <!-- <a onClick="deleteAll();" class="btn btn-danger mx-1 ti-trash" >&nbsp;Delete All</a> -->
        <a
          onClick="deleteAll();"
          class="btn btn-danger text-white mx-1"
          role="button"
          ><i class="fa-solid fa-trash"></i> Delete All</a
        >

        <!-- <a href="/masteritem/start_override" class="btn btn-success mx-1"><i
                                                            class="fa-solid fa-right-to-bracket"></i> Bulk Run</a> -->
      </div>
    </div>

    <form method="post" autocomplete="off" id="add_item_excel">
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">
                Select Excel File
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input type="file" id="input" name="input" />
            </div>

            <div class="px-2 pb-3 d-flex align-items-center">
              <div>
                <label class="switch">
                  <input type="checkbox" name="switch_on" />
                  <span class="slider"></span>
                </label>
              </div>
              <div>
                <h6 class="mb-0 mt-3">Override Existing</h6>
              </div>
            </div>

            <div class="modal-footer">
              <a href="/sample.xlsx" class="btn btn-primary">
                Sample Download
              </a>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary addItemExcel">
                Update
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="card mt-4">
      <div>
        <form method="GET" id="" action="show_all" class="mt-3">
          <div class="row">
            <div class="col form-group mx-sm-3 mb-2">
              <input
                type="text"
                class="form-control"
                id="tags"
                name="tags"
                value="<%= tags %>"
                placeholder="Search"
              />
            </div>
            <div class="col">
              <button
                type="submit"
                name="search"
                value="true"
                class="btn btn-primary mb-2 mr-2"
              >
                <i class="fa-solid fa-magnifying-glass"></i> Search
              </button>
              <% if (tags !='' ) { %>
              <a href="/productV2/show_all" class="btn btn-danger mb-2 mr-2"
                ><i class="fa-solid fa-xmark"></i> Cancel</a
              >
              <% } %>
            </div>
          </div>
        </form>
      </div>
      <% if(items.length===0) { %>
      <div class="m-2">No items found !</div>
      <% } else { %>
      <div class="body table-responsive">
        <table
          id="example"
          class="table table-striped table-bordered"
          style="width: auto"
        >
          <thead class="table-primary">
            <tr>
              <th class="t-head"></th>
              <th class="t-head">Active</th>
              <th class="t-head">MPID</th>
              <th class="t-head">Channel ID</th>
              <th class="t-head">Last run cron-type</th>
              <th class="t-head">Last updated cron-type</th>
              <th class="t-head">Last Reprice Comment</th>
              <th class="t-head">Last Suggested Price</th>
              <th class="t-head">Unit Price</th>
              <th class="t-head">Floor Price</th>
              <th class="t-head">NC</th>
              <th class="t-head">Badge Indicator</th>
              <th class="t-head">Badge Percentage(%)</th>
              <th class="t-head">Product Name</th>
              <th class="t-head">Cron Name</th>
              <th class="t-head">Reprice - Scrape</th>
              <th class="t-head">Reprice</th>
              <th class="t-head">Execution Priority</th>
              <th class="t-head">Max Price</th>
              <th class="t-head">Focus ID</th>
            </tr>
          </thead>
          <tbody>
            <% items.forEach(function(item) { %>
            <tr style="height: 50 px; width: auto">
              <td>
                <a href="/productV2/editItem/<%= item.mpid %>"
                  ><i class="ti-pencil-alt"></i
                ></a>
                &nbsp;
                <a onclick="removeItem('<%= item.mpid%>');"
                  ><i class="ti-trash"></i
                ></a>
              </td>
              <td>
                <%= item.activated %>
                <br />
                <a
                  onClick="activateProductForAll('<%= item.mpid%> ')"
                  class="btn btn-success mb-2 mr-2"
                  style="float: right; color: antiquewhite"
                  ><i class="fa-solid fa-floppy-disk"></i> Activate All</a
                >
              </td>
              <td>
                <%= item.mpid %>
              </td>
              <td>
                <%= item.channelId %>
              </td>
              <td>
                <%= item.lastCronRun %>
              </td>
              <td>
                <%= item.lastUpdatedBy %>
              </td>
              <td>
                <%= item.last_cron_message %>
              </td>
              <td>
                <%= item.lastSuggestedPrice %>
              </td>
              <td>
                <%= item.unitPrice %>
              </td>
              <td>
                <%= item.floorPrice %>
              </td>
              <td>
                <%= item.is_nc_needed %>
              </td>
              <td>
                <%= item.badge_indicator %>
              </td>
              <td>
                <%= item.badgePercentage %>
              </td>
              <td>
                <%= item.productName %>
              </td>
              <td>
                <%= item.cronName %>
              </td>

              <td>
                <%= item.scrapeOn %>
              </td>
              <td>
                <%= item.allowReprice %>
              </td>
              <td>
                <%= item.executionPriority %>
              </td>
              <td>
                <%= item.maxPrice %>
              </td>
              <td>
                <%= item.focusId %>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        <% } %>
      </div>

      <!-- pagination -->
      <div
        class="card border-0 flex-column justify-content-between p-2 track-ccard-b bg-transparent"
      >
        <div md="" class="col mt-4 text-center">
          <nav aria-label="" class="">
            <ul class="pagination justify-content-center">
              <li class="page-item p-2">
                <a href="/productV2/show_all?pgno=1&tags=<%= tags %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    &laquo;
                  </button></a
                >
              </li>
              <li class="page-item p-2">
                <a
                  href="/productV2/show_all?pgno=<%= Math.max(1, pageNumber) %>&tags=<%= tags %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    Previous
                  </button></a
                >
              </li>
              <% pages.slice(upVal, lowVal).map(pg=> { let active = (pg ===
              pageNumber) ? '-active' : '' %>
              <li class="page-item p-2">
                <a
                  href="/productV2/show_all?pgno=<%= (pg + 1) %>&tags=<%= tags %>"
                  ><button
                    class="btn tracknumlisting-pagination-button <%- active %>"
                  >
                    <%= (pg + 1) %>
                  </button></a
                >
              </li>

              <% }) %>
              <li class="page-item p-2">
                <a
                  href="/productV2/show_all?pgno=<%= Math.min(totalPages, Number(pageNumber) + 2) %>&tags=<%= tags %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    Next
                  </button></a
                >
              </li>
              <li class="page-item p-2">
                <a
                  href="/productV2/show_all?pgno=<%= totalPages %>&tags=<%= tags %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    &raquo;
                  </button></a
                >
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include("../footer"); %>
<style>
  /* Basic Rules */
  .switch input {
    display: none;
  }

  .switch {
    display: inline-block;
    width: 52px;
    height: 22px;
    margin: 8px;
    transform: translateY(50%);
    position: relative;
  }

  /* Style Wired */
  .slider {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    border-radius: 30px;
    box-shadow:
      0 0 0 2px #777,
      0 0 4px #777;
    cursor: pointer;
    border: 4px solid transparent;
    overflow: hidden;
    transition: 0.4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    width: 100%;
    height: 100%;
    background: #777;
    border-radius: 30px;
    transform: translateX(-30px);
    transition: 0.4s;
  }

  input:checked + .slider:before {
    transform: translateX(30px);
    background: limeGreen;
  }

  input:checked + .slider {
    box-shadow:
      0 0 0 2px limeGreen,
      0 0 2px limeGreen;
  }

  /* Style Flat */
  .switch.flat .slider {
    box-shadow: none;
  }

  .switch.flat .slider:before {
    background: #fff;
  }

  .switch.flat input:checked + .slider:before {
    background: white;
  }

  .switch.flat input:checked + .slider {
    background: limeGreen;
  }

  .t-head {
    position: sticky;
    top: 0px;
    left: 0px;
    z-index: 9;
    background-color: #c3dfff;
  }

  .table-responsive {
    max-height: 500px;
    margin: 20px;
    padding: 0 !important;
  }
</style>
