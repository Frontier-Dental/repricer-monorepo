<%- include('header') %>
<%- include('left-sidebar') %>

<% let pgno=pageNumber + 1; let upVal=0, lowVal=0 ; const pages=new
Array(totalPages).fill(null).map((v, i)=> i); if (pageNumber <= 2) { upVal=0;
lowVal=5 } else if (pageNumber>= (totalPages - 3)) { upVal = totalPages - 5;
lowVal = totalPages } else { upVal = pageNumber - 2; lowVal = pageNumber + 3 }
%>

<div class="page">
  <div class="container-fluid">
    <div class="d-flex justify-content-between">
      <h1 class="commanHeading">Waitlist Items <span class="text-muted">(<%= totalDocs %>)</span></h1>
      <div class="d-flex">
        <% if(items && items.length !=0){ %>
        <button
          type="button"
          onClick="deleteAllWaitlistItems();"
          class="btn btn-danger text-white mx-1"
          role="button"
          ><i class="fa-solid fa-trash"></i> Delete Selected</button
        >
        <% } %>
      </div>
    </div>

    <div class="card mt-4">
      <div>
        <form method="GET" id="" action="/waitlist" class="mt-3">
          <div class="row">
            <div class="col form-group mx-sm-3 mb-2">
              <input
                type="text"
                class="form-control"
                id="search"
                name="search"
                value="<%= typeof search !== 'undefined' ? search : '' %>"
                placeholder="Search by vendor name"
              />
            </div>
            <div class="col form-group mx-sm-3 mb-2">
              <select
                class="form-control"
                id="status"
                name="status"
              >
                <option value="">All Status</option>
                <option value="pending" <%= typeof status !== 'undefined' && status === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="success" <%= typeof status !== 'undefined' && status === 'success' ? 'selected' : '' %>>Success</option>
                <option value="failed" <%= typeof status !== 'undefined' && status === 'failed' ? 'selected' : '' %>>Failed</option>
              </select>
            </div>
            <div class="col form-group mx-sm-3 mb-2">
              <input
                type="date"
                class="form-control"
                id="fromDate"
                name="fromDate"
                value="<%= typeof fromDate !== 'undefined' ? fromDate : '' %>"
                placeholder="From Date"
              />
            </div>
            <div class="col form-group mx-sm-3 mb-2">
              <input
                type="date"
                class="form-control"
                id="toDate"
                name="toDate"
                value="<%= typeof toDate !== 'undefined' ? toDate : '' %>"
                placeholder="To Date"
              />
            </div>
            <div class="col">
              <button
                type="submit"
                class="btn btn-success mb-2 mr-2"
              >
                <i class="fa-solid fa-magnifying-glass"></i> Search
              </button>
              <a href="/waitlist" class="btn btn-danger mb-2 mr-2"
                ><i class="fa-solid fa-xmark"></i> Clear</a
              >
            </div>
          </div>
        </form>
      </div>
      <% if(items.length===0) { %>
      <div class="m-2">No waitlist items found !</div>
      <% } else { %>
      <div class="body table-responsive">
        <table
          id="example"
          class="table table-striped table-bordered"
        >
          <thead class="table-primary">
            <tr>
              <th class="t-head">
                <input
                  type="checkbox"
                  id="selectAll"
                  onclick="toggleSelectAll()"
                />
              </th>
              <!-- <th class="t-head">ID</th> -->
              <th class="t-head">MP ID</th>
              <th class="t-head">Vendor Name</th>
              <th class="t-head">Old Inventory</th>
              <th class="t-head">New Inventory</th>
              <th class="t-head">Net32 Inventory</th>
              <th class="t-head">API Status</th>
              <th class="t-head">Message</th>
              <th class="t-head">Created At</th>
              <!-- <th class="t-head">Updated At</th> -->
              <th class="t-head">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% items.forEach(function(item) { %>
            <tr style="height: 50px; width: auto">
              <td>
                <input
                  type="checkbox"
                  class="item-checkbox"
                  value="<%= item.id %>"
                />
              </td>
              <td>
                <%= item.mp_id %>
              </td>
              <td>
                <%= item.vendor_name %>
              </td>
              <td>
                <%= item.old_inventory %>
              </td>
              <td>
                <%= item.new_inventory %>
              </td>
              <td>
                <%= item.net32_inventory %>
              </td>
              <td>
                <span class="badge badge-<%= item.api_status === 'success' ? 'success' : item.api_status === 'failed' ? 'danger' : 'warning' %>">
                  <%= item.api_status || 'pending' %>
                </span>
              </td>
              <td>
                <%= item.message || 'N/A' %>
              </td>
              <td>
                <%= item.created_at ? new Date(item.created_at).toLocaleString() : 'N/A' %>
              </td>
              <td>
                <a onclick="deleteWaitlistItem('<%= item.id %>');"
                  ><i class="ti-trash"></i
                ></a>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        <% } %>
      </div>

      <!-- pagination -->
      <% if(totalPages > 1) { 
        let queryParams = [];
        if (status) queryParams.push(`status=${encodeURIComponent(status)}`);
        if (fromDate) queryParams.push(`fromDate=${encodeURIComponent(fromDate)}`);
        if (toDate) queryParams.push(`toDate=${encodeURIComponent(toDate)}`);
        if (search) queryParams.push(`search=${encodeURIComponent(search)}`);
        let queryString = queryParams.length > 0 ? '&' + queryParams.join('&') : '';
      %>
      <div
        class="card border-0 flex-column justify-content-between p-2 track-ccard-b bg-transparent"
      >
        <div md="" class="col mt-4 text-center">
          <nav aria-label="" class="">
            <ul class="pagination justify-content-center">
              <li class="page-item p-2">
                <a href="/waitlist?page=1<%= queryString %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    &laquo;
                  </button></a
                >
              </li>
              <li class="page-item p-2">
                <a
                  href="/waitlist?page=<%= Math.max(1, pageNumber) %><%= queryString %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    Previous
                  </button></a
                >
              </li>
              <% pages.slice(upVal, lowVal).map(pg=> { let active = (pg ===
              pageNumber) ? '-active' : '' %>
              <li class="page-item p-2">
                <a
                  href="/waitlist?page=<%= (pg + 1) %><%= queryString %>"
                  ><button
                    class="btn tracknumlisting-pagination-button <%- active %>"
                  >
                    <%= (pg + 1) %>
                  </button></a
                >
              </li>

              <% }) %>
              <li class="page-item p-2">
                <a
                  href="/waitlist?page=<%= Math.min(totalPages, Number(pageNumber) + 2) %><%= queryString %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    Next
                  </button></a
                >
              </li>
              <li class="page-item p-2">
                <a
                  href="/waitlist?page=<%= totalPages %><%= queryString %>"
                  ><button class="btn tracknumlisting-pagination-button">
                    &raquo;
                  </button></a
                >
              </li>
            </ul>
          </nav>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<%- include("footer"); %>

<script>
  function deleteWaitlistItem(id) {
    if (confirm("Are you sure you want to delete this waitlist item?")) {
      $.ajax({
        type: "DELETE",
        url: `/waitlist/${id}`,
        dataType: "json",
        cache: false,
        beforeSend: function () {
          showLoadingToast("Processing...");
        },
        success: function (data) {
          showSuccessToast("Waitlist item deleted successfully");
          setTimeout(function () {
            location.reload();
          }, 1000);
        },
        error: function () {
          showErrorToast("Oops unable to connect with server!!");
        },
      });
    }
  }

  function deleteAllWaitlistItems() {
    const selectedIds = [];
    $(".item-checkbox:checked").each(function () {
      selectedIds.push($(this).val());
    });

    if (selectedIds.length === 0) {
      showErrorToast("Please select at least one item to delete");
      return;
    }

    if (confirm(`Are you sure you want to delete ${selectedIds.length} waitlist item(s)?`)) {
      $.ajax({
        type: "DELETE",
        url: "/waitlist/bulk/items",
        data: JSON.stringify({ ids: selectedIds }),
        contentType: "application/json",
        dataType: "json",
        cache: false,
        beforeSend: function () {
          showLoadingToast("Processing...");
        },
        success: function (data) {
          showSuccessToast(`${selectedIds.length} waitlist item(s) deleted successfully`);
          setTimeout(function () {
            location.reload();
          }, 1000);
        },
        error: function () {
          showErrorToast("Something went wrong. Please try again");
        },
      });
    }
  }

  function toggleSelectAll() {
    const selectAll = document.getElementById("selectAll");
    const checkboxes = document.querySelectorAll(".item-checkbox");
    checkboxes.forEach(function (checkbox) {
      checkbox.checked = selectAll.checked;
    });
  }
</script>

<style>
  .t-head {
    position: sticky;
    top: 0px;
    left: 0px;
    z-index: 9;
    background-color: #c3dfff;
  }

  .table-responsive {
    max-height: 500px;
    margin: 20px;
    padding: 0 !important;
  }

  .badge {
    padding: 0.25em 0.6em;
    font-size: 0.875em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
  }

  .badge-success {
    color: #fff;
    background-color: #28a745;
  }

  .badge-danger {
    color: #fff;
    background-color: #dc3545;
  }

  .badge-warning {
    color: #212529;
    background-color: #ffc107;
  }
</style>

