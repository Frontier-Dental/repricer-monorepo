<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2 Repricer Algorithm - Visual Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --blue: #3b82f6;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --gray: #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            padding: 2rem;
            text-align: center;
        }

        header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        header p { opacity: 0.9; font-size: 1.1rem; }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        nav {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        nav a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        nav a:hover { background: #334155; color: #fff; }

        section {
            background: #1e293b;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            color: #fff;
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #334155;
        }

        h3 {
            color: #94a3b8;
            font-size: 1.25rem;
            margin: 1.5rem 0 1rem;
        }

        /* Mermaid diagram container */
        .mermaid-container {
            background: #0f172a;
            border-radius: 12px;
            padding: 2rem;
            overflow-x: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        /* Phase cards */
        .phase-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .phase-card {
            background: #0f172a;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--blue);
        }

        .phase-card.filter { border-left-color: var(--yellow); }
        .phase-card.calculate { border-left-color: var(--green); }
        .phase-card.blocking { border-left-color: var(--red); }
        .phase-card.result { border-left-color: var(--purple); }
        .phase-card.validation { border-left-color: var(--cyan); }

        .phase-card h4 {
            color: #fff;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phase-card h4 .num {
            background: #334155;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        .phase-card ul {
            list-style: none;
            padding-left: 0;
        }

        .phase-card li {
            padding: 0.3rem 0;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .phase-card li::before {
            content: "→ ";
            color: #475569;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            background: #0f172a;
            color: #fff;
            font-weight: 600;
        }

        tr:hover { background: rgba(255,255,255,0.02); }

        code {
            background: #334155;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tag-change { background: #064e3b; color: #34d399; }
        .tag-ignore { background: #7f1d1d; color: #fca5a5; }
        .tag-bypass { background: #1e3a8a; color: #93c5fd; }

        /* Example cards */
        .example {
            background: #0f172a;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid #334155;
        }

        .example-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #334155;
        }

        .example-header h4 {
            color: #fff;
            font-size: 1.1rem;
        }

        .example-result {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .example-result.up { background: #064e3b; color: #34d399; }
        .example-result.down { background: #1e3a8a; color: #93c5fd; }
        .example-result.new { background: #713f12; color: #fcd34d; }
        .example-result.ignore { background: #7f1d1d; color: #fca5a5; }

        .example-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .example-grid { grid-template-columns: 1fr; }
        }

        .example-box {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
        }

        .example-box h5 {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .example-data {
            font-size: 0.9rem;
        }

        .example-data > div {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .example-data .label { color: #64748b; }
        .example-data .value { color: #e2e8f0; font-weight: 500; }

        .flow-steps {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .flow-step {
            padding: 0.4rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .flow-step::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #475569;
        }

        .flow-step.pass::before { background: var(--green); }
        .flow-step.fail::before { background: var(--red); }
        .flow-step.calc::before { background: var(--blue); }
        .flow-step.result::before { background: var(--yellow); }

        .hl { color: var(--yellow); }
        .ok { color: var(--green); }
        .err { color: var(--red); }

        /* Buy box rules visualization */
        .buybox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .buybox-card {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #334155;
        }

        .buybox-card h5 {
            color: #fff;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .formula {
            background: #334155;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            text-align: center;
            margin: 0.5rem 0;
        }

        .formula-note {
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            border-top: 1px solid #334155;
        }
    </style>
</head>
<body>
    <header>
        <h1>V2 Repricer Algorithm</h1>
        <p>Visual Flowchart & Complete Reference</p>
        <div class="badge">Validated Against Codebase: 2025-11-25</div>
    </header>

    <div class="container">
        <nav>
            <a href="#main-flow">Main Flowchart</a>
            <a href="#phases">Algorithm Phases</a>
            <a href="#filters">Competition Filters</a>
            <a href="#strategies">Price Strategies</a>
            <a href="#blocking">Blocking Rules</a>
            <a href="#qbreak">Q-Break Validation</a>
            <a href="#buybox">Buy Box Rules</a>
            <a href="#examples">Examples</a>
        </nav>

        <!-- Main Flowchart -->
        <section id="main-flow">
            <h2>Main Algorithm Flowchart</h2>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div> Input/Process</div>
                <div class="legend-item"><div class="legend-color" style="background:#f59e0b"></div> Filter</div>
                <div class="legend-item"><div class="legend-color" style="background:#10b981"></div> Calculation</div>
                <div class="legend-item"><div class="legend-color" style="background:#ef4444"></div> Blocking Check</div>
                <div class="legend-item"><div class="legend-color" style="background:#8b5cf6"></div> Result</div>
                <div class="legend-item"><div class="legend-color" style="background:#ec4899"></div> Decision</div>
            </div>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    subgraph INPUT["1. INPUT"]
        A[Net32 Products] --> B[v2_algo_settings]
        B --> C[Vendor Thresholds]
        C --> D[Job Metadata<br/>cronName, isSlowCron]
    end

    subgraph PREFILTER["2. PRE-FILTER"]
        D --> E{Valid priceBreaks?}
        E -->|Yes| F[Separate Own vs Competitors]
        E -->|No| SKIP1[Skip Product]
        F --> G{In 422 Error List?}
        G -->|No| H{Vendor Enabled?}
        G -->|Yes| SKIP2[Skip Vendor]
        H -->|Yes| I[Add to Available Vendors]
        H -->|No| SKIP3[Skip Vendor]
    end

    subgraph VENDORLOOP["3. FOR EACH VENDOR"]
        I --> J[Get Vendor Settings]
        J --> K[Get Pre-JSON Position]
        K --> L[Apply Competition Filters]
    end

    subgraph FILTERS["4. COMPETITION FILTERS"]
        L --> F1[1. Vendor Exclusion]
        F1 --> F2[2. Min Inventory]
        F2 --> F3[3. Handling Time]
        F3 --> F4[4. Badge Indicator]
        F4 --> F5[5. Short Expiry]
        F5 --> M[Filtered Competitors]
    end

    subgraph QLOOP["5. FOR EACH QUANTITY"]
        M --> N[Get Compete Quantity]
        N --> O[Rank Competitors]
        O --> P{Price Strategy?}
    end

    subgraph CALC["6. PRICE CALCULATION"]
        P -->|UNIT| Q1[Unit Price Undercut]
        P -->|TOTAL| Q2[Total Cost → Derive Unit]
        P -->|BUY_BOX| Q3[Badge/Shipping Bonuses]
        Q1 --> R{Price Within<br/>Floor-Max?}
        Q2 --> R
        Q3 --> R
        R -->|Yes| S[bestPrice Set]
        R -->|No| T[bestPrice = null]
    end

    subgraph BLOCKING["7. BLOCKING RULES (12 checks)"]
        S --> B1{No Best Price?}
        T --> B1
        B1 -->|Yes| IGN1[IGNORE_FLOOR]
        B1 -->|No| B2{Own Threshold?}
        B2 -->|Fail| IGN2[IGNORE_SETTINGS]
        B2 -->|Pass| B3{Short Expiry?}
        B3 -->|Yes| IGN3[IGNORE_SHORT_EXPIRY]
        B3 -->|No| B4{Sister in BuyBox?}
        B4 -->|Yes| IGN4[IGNORE_SISTER_LOWEST]
        B4 -->|No| B5{Already Winning<br/>+ DOWN only?}
        B5 -->|Yes| IGN5[IGNORE_LOWEST]
        B5 -->|No| MORE[...6 More Rules...]
        MORE --> RESULT
    end

    subgraph RESULTDET["8. RESULT DETERMINATION"]
        RESULT{All Rules Pass?}
        RESULT -->|Yes| DET{Compare Prices}
        DET -->|New Q-Break| CHG1[CHANGE_NEW]
        DET -->|Price Down| CHG2[CHANGE_DOWN]
        DET -->|Price Up| CHG3[CHANGE_UP]
        RESULT -->|No| IGNORED[IGNORE_*]
    end

    subgraph QVALID["9. Q-BREAK VALIDATION"]
        CHG1 --> V1{Hierarchy Valid?}
        CHG2 --> V1
        CHG3 --> V1
        V1 -->|No| INVQ[qBreakValid = false]
        V1 -->|Yes| V2{Q1 Updated?<br/>if required}
        V2 -->|No| INVQ
        V2 -->|Yes| VALIDQ[qBreakValid = true]
    end

    subgraph EXEC["10. EXECUTION"]
        VALIDQ --> E1{Execution Priority?}
        E1 -->|Not Lowest| NOEXEC[NOT_EXECUTION_PRIORITY]
        E1 -->|Lowest| E2{Dev Mode?}
        E2 -->|Yes| DEVBLOCK[CHANGE_PREVENTED DEV]
        E2 -->|No| E3{V2 Enabled?}
        E3 -->|No| V2BLOCK[CHANGE_PREVENTED V2]
        E3 -->|Yes| API[Net32 API Call]
        API --> DONE[OK / ERROR_422]
    end

    style INPUT fill:#1e3a8a,stroke:#3b82f6,color:#fff
    style PREFILTER fill:#713f12,stroke:#f59e0b,color:#fff
    style VENDORLOOP fill:#1e3a8a,stroke:#3b82f6,color:#fff
    style FILTERS fill:#713f12,stroke:#f59e0b,color:#fff
    style QLOOP fill:#1e3a8a,stroke:#3b82f6,color:#fff
    style CALC fill:#064e3b,stroke:#10b981,color:#fff
    style BLOCKING fill:#7f1d1d,stroke:#ef4444,color:#fff
    style RESULTDET fill:#4c1d95,stroke:#8b5cf6,color:#fff
    style QVALID fill:#164e63,stroke:#06b6d4,color:#fff
    style EXEC fill:#1e3a8a,stroke:#3b82f6,color:#fff
                </pre>
            </div>
        </section>

        <!-- Algorithm Phases -->
        <section id="phases">
            <h2>Algorithm Phases Overview</h2>

            <div class="phase-grid">
                <div class="phase-card">
                    <h4><span class="num">1</span> Input Collection</h4>
                    <ul>
                        <li>Net32 products with price breaks</li>
                        <li>v2_algo_settings per vendor</li>
                        <li>Vendor shipping thresholds</li>
                        <li>Job context (cronName, isSlowCron)</li>
                    </ul>
                </div>

                <div class="phase-card filter">
                    <h4><span class="num">2</span> Pre-Filter</h4>
                    <ul>
                        <li>Valid priceBreaks array exists</li>
                        <li>Not in 422 error list</li>
                        <li>Vendor enabled = true</li>
                        <li>Separate own vs competitors</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4><span class="num">3</span> Vendor Loop</h4>
                    <ul>
                        <li>For each available own vendor</li>
                        <li>Load vendor-specific settings</li>
                        <li>Get pre-JSON position</li>
                        <li>Build filtered competition list</li>
                    </ul>
                </div>

                <div class="phase-card filter">
                    <h4><span class="num">4</span> Competition Filters</h4>
                    <ul>
                        <li>5-stage filter pipeline</li>
                        <li>Applied via lodash flow()</li>
                        <li>Per-vendor configuration</li>
                        <li>Reduces competition set</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4><span class="num">5</span> Quantity Loop</h4>
                    <ul>
                        <li>For each valid Q-break</li>
                        <li>Special Q2→Q1 comparison</li>
                        <li>Rank competitors by strategy</li>
                        <li>Prepare for calculation</li>
                    </ul>
                </div>

                <div class="phase-card calculate">
                    <h4><span class="num">6</span> Price Calculation</h4>
                    <ul>
                        <li>3 strategies: UNIT, TOTAL, BUY_BOX</li>
                        <li>Find undercut price</li>
                        <li>Check floor/max bounds</li>
                        <li>Return bestPrice or null</li>
                    </ul>
                </div>

                <div class="phase-card blocking">
                    <h4><span class="num">7</span> Blocking Rules</h4>
                    <ul>
                        <li>12 sequential checks</li>
                        <li>First failure blocks change</li>
                        <li>Some bypassed by slow cron</li>
                        <li>Returns IGNORE_* result</li>
                    </ul>
                </div>

                <div class="phase-card result">
                    <h4><span class="num">8</span> Result Determination</h4>
                    <ul>
                        <li>CHANGE_NEW (new Q-break)</li>
                        <li>CHANGE_DOWN (price decrease)</li>
                        <li>CHANGE_UP (price increase)</li>
                        <li>Or blocked IGNORE_* result</li>
                    </ul>
                </div>

                <div class="phase-card validation">
                    <h4><span class="num">9</span> Q-Break Validation</h4>
                    <ul>
                        <li>Hierarchy check (Q2 &lt; Q1 price)</li>
                        <li>Q1 dependency check</li>
                        <li>Both must pass</li>
                        <li>Invalid → IGNORE_SETTINGS</li>
                    </ul>
                </div>

                <div class="phase-card">
                    <h4><span class="num">10</span> Execution</h4>
                    <ul>
                        <li>Execution priority check</li>
                        <li>Dev mode check</li>
                        <li>V2 enabled check</li>
                        <li>Net32 API call</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Competition Filters -->
        <section id="filters">
            <h2>Competition Filters Pipeline</h2>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart LR
    A[All Competitors] --> F1

    subgraph PIPELINE["Filter Pipeline (lodash flow)"]
        F1["1. Vendor Exclusion<br/><code>exclude_vendors</code>"] --> F2
        F2["2. Min Inventory<br/><code>inventory_competition_threshold</code>"] --> F3
        F3["3. Handling Time<br/><code>handling_time_group</code>"] --> F4
        F4["4. Badge Indicator<br/><code>badge_indicator</code>"] --> F5
        F5["5. Short Expiry<br/><code>promoAddlDescr EXP</code>"]
    end

    F5 --> B[Filtered Competitors]

    style F1 fill:#713f12,stroke:#f59e0b,color:#fff
    style F2 fill:#713f12,stroke:#f59e0b,color:#fff
    style F3 fill:#713f12,stroke:#f59e0b,color:#fff
    style F4 fill:#713f12,stroke:#f59e0b,color:#fff
    style F5 fill:#713f12,stroke:#f59e0b,color:#fff
                </pre>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Filter</th>
                        <th>Setting</th>
                        <th>Logic</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>Vendor Exclusion</strong></td>
                        <td><code>exclude_vendors</code></td>
                        <td>Exclude vendors by comma-separated IDs</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Min Inventory</strong></td>
                        <td><code>inventory_competition_threshold</code></td>
                        <td>inventory &ge; threshold (except inactive_vendor_id)</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Handling Time</strong></td>
                        <td><code>handling_time_group</code></td>
                        <td>ALL | FAST_SHIPPING (1-2d) | STOCKED (&le;5d) | LONG_HANDLING (&ge;6d)</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Badge Indicator</strong></td>
                        <td><code>badge_indicator</code></td>
                        <td>ALL | BADGE (fallback to all if none have badge)</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Short Expiry</strong></td>
                        <td><code>promoAddlDescr</code></td>
                        <td>Exclude if contains "EXP"</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Price Strategies -->
        <section id="strategies">
            <h2>Price Strategies</h2>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    A{price_strategy?}

    A -->|UNIT| U[UNIT Strategy]
    A -->|TOTAL| T[TOTAL Strategy]
    A -->|BUY_BOX| B[BUY_BOX Strategy]

    subgraph UNIT_CALC["UNIT: Simple Unit Price"]
        U --> U1[Sort by unit price]
        U1 --> U2[Undercut by $0.01<br/>or reprice_down_percentage]
        U2 --> U3{Within floor-max?}
        U3 -->|Yes| U4[Return price]
        U3 -->|No| U5[Try next competitor]
    end

    subgraph TOTAL_CALC["TOTAL: Total Cost Comparison"]
        T --> T1[Calculate total cost<br/>unitPrice × qty + shipping]
        T1 --> T2[Undercut total by $0.01]
        T2 --> T3[Derive unit price<br/>accounting for threshold]
        T3 --> T4{Within floor-max?}
        T4 -->|Yes| T5[Return price]
        T4 -->|No| T6[Try next competitor]
    end

    subgraph BUYBOX_CALC["BUY_BOX: Badge/Shipping Bonuses"]
        B --> B1[Calculate total cost]
        B1 --> B2[Apply buy box multipliers<br/>Badge: ±10%, Shipping: ±0.5%]
        B2 --> B3[Derive unit price]
        B3 --> B4{Within floor-max?}
        B4 -->|Yes| B5[Return price]
        B4 -->|No| B6[Try next competitor]
    end

    style UNIT_CALC fill:#1e3a8a,stroke:#3b82f6,color:#fff
    style TOTAL_CALC fill:#064e3b,stroke:#10b981,color:#fff
    style BUYBOX_CALC fill:#4c1d95,stroke:#8b5cf6,color:#fff
                </pre>
            </div>

            <div class="phase-grid">
                <div class="phase-card">
                    <h4>UNIT Strategy</h4>
                    <ul>
                        <li><strong>Compare:</strong> Unit price only</li>
                        <li><strong>Sort:</strong> Lowest unit price first</li>
                        <li><strong>Undercut:</strong> $0.01 or percentage</li>
                        <li><strong>Best for:</strong> Simple competition</li>
                    </ul>
                    <div class="formula">newPrice = competitor - $0.01</div>
                </div>

                <div class="phase-card calculate">
                    <h4>TOTAL Strategy</h4>
                    <ul>
                        <li><strong>Compare:</strong> Total cost (unit × qty + ship)</li>
                        <li><strong>Sort:</strong> Lowest total cost first</li>
                        <li><strong>Undercut:</strong> Total, then derive unit</li>
                        <li><strong>Best for:</strong> Shipping-sensitive items</li>
                    </ul>
                    <div class="formula">totalCost = unitPrice × qty + shipping</div>
                </div>

                <div class="phase-card result">
                    <h4>BUY_BOX Strategy</h4>
                    <ul>
                        <li><strong>Compare:</strong> Total + badge + shipping</li>
                        <li><strong>Sort:</strong> Buy box ranking rules</li>
                        <li><strong>Undercut:</strong> Dynamic multipliers</li>
                        <li><strong>Best for:</strong> Highly competitive SKUs</li>
                    </ul>
                    <div class="formula">Badge bonus: 10% | Shipping: 0.5%</div>
                </div>
            </div>
        </section>

        <!-- Blocking Rules -->
        <section id="blocking">
            <h2>Blocking Rules (12 Checks)</h2>

            <p style="margin-bottom:1rem;color:#94a3b8;">Applied in <code>getSolutionResult()</code> after price calculation. First failure blocks the change.</p>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Rule</th>
                        <th>Condition</th>
                        <th>Result</th>
                        <th>Slow Cron</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>No Best Price</strong></td>
                        <td><code>bestPrice === null</code></td>
                        <td><span class="tag tag-ignore">IGNORE_FLOOR</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Own Vendor Threshold</strong></td>
                        <td><code>vendor.inventory &lt; own_vendor_threshold</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SETTINGS</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Short Expiry (Own)</strong></td>
                        <td><code>priceBreak.promoAddlDescr.includes("EXP")</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SHORT_EXPIRY</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Real Sister in BuyBox</strong></td>
                        <td>Another own vendor has <code>buyBoxRank = 0</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SISTER_LOWEST</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Simulated Sister in BuyBox</strong></td>
                        <td><code>sister_vendor_ids</code> vendor has <code>buyBoxRank = 0</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SISTER_LOWEST</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td><strong>Already Winning + DOWN</strong></td>
                        <td><code>buyBoxRank === 0 && up_down === DOWN</code></td>
                        <td><span class="tag tag-ignore">IGNORE_LOWEST</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td><strong>Floor Compete with Next</strong></td>
                        <td><code>floor_compete_with_next === OFF && buyBoxRank > 0</code><br/>
                            <em>Special: Q2 + compare_q2_with_q1 + buyBoxRank>0</em></td>
                        <td><span class="tag tag-ignore">IGNORE_FLOOR</span></td>
                        <td><span class="tag tag-bypass">BYPASS</span></td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td><strong>Compete Price Breaks Only</strong></td>
                        <td><code>compete_on_price_break_only === ON && quantity === 1</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SETTINGS</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td><strong>Suppress Price Break</strong></td>
                        <td><code>suppress_price_break === ON && quantity > 1</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SETTINGS</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td><strong>Up/Down Restriction</strong></td>
                        <td><code>up_down === UP && suggested &lt; existing</code><br/>
                            <code>up_down === DOWN && suggested > existing</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SETTINGS</span></td>
                        <td><span class="tag tag-bypass">BYPASS</span></td>
                    </tr>
                    <tr>
                        <td>11</td>
                        <td><strong>Same Price</strong></td>
                        <td><code>suggestedPrice === existingPrice</code></td>
                        <td><span class="tag tag-ignore">IGNORE_LOWEST</span> or <span class="tag tag-ignore">IGNORE_FLOOR</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>12</td>
                        <td><strong>Keep Position</strong></td>
                        <td><code>keep_position === ON && lowestVendorPos > preJsonPos</code></td>
                        <td><span class="tag tag-ignore">IGNORE_SETTINGS</span></td>
                        <td><span class="tag tag-bypass">BYPASS</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Slow Cron Bypasses</h3>
            <p style="color:#94a3b8;">When <code>isSlowCron = true</code>, these rules are bypassed:</p>
            <ul style="margin-top:0.5rem;margin-left:1.5rem;color:#94a3b8;">
                <li>Rule 7: Floor Compete with Next (partial)</li>
                <li>Rule 10: Up/Down Restriction</li>
                <li>Rule 12: Keep Position</li>
            </ul>
        </section>

        <!-- Q-Break Validation -->
        <section id="qbreak">
            <h2>Q-Break Validation</h2>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    A[Solutions with CHANGE_* result] --> B{Check 1:<br/>Hierarchy Valid?}

    B -->|"Q2 price ≤ Q1 price"| C[UNNECESSARY]
    B -->|"Q2 price > Q1 price"| D{Check 2:<br/>Q1 Updated?}

    D -->|"suppress_price_break_if_Q1_not_updated = false"| E[qBreakValid = true]
    D -->|"Q1 has CHANGE result"| E
    D -->|"slow cron"| E
    D -->|"Q1 NOT changing"| F[SUPPRESS_BECAUSE_Q1_NOT_UPDATED]

    C --> G[qBreakValid = false]
    F --> G

    G --> H[algoResult = IGNORE_SETTINGS]
    E --> I[Proceed to Execution]

    style C fill:#7f1d1d,stroke:#ef4444,color:#fff
    style F fill:#7f1d1d,stroke:#ef4444,color:#fff
    style G fill:#7f1d1d,stroke:#ef4444,color:#fff
    style E fill:#064e3b,stroke:#10b981,color:#fff
    style I fill:#064e3b,stroke:#10b981,color:#fff
                </pre>
            </div>

            <div class="phase-grid">
                <div class="phase-card blocking">
                    <h4>Check 1: Hierarchy</h4>
                    <p style="color:#94a3b8;font-size:0.9rem;">Higher quantity breaks must have lower prices than lower quantity breaks.</p>
                    <div class="formula">Q2 price MUST be &lt; Q1 price</div>
                    <p style="color:#64748b;font-size:0.85rem;margin-top:0.5rem;">If Q2=$15 and Q1=$15, Q2 provides no discount benefit → UNNECESSARY</p>
                </div>

                <div class="phase-card blocking">
                    <h4>Check 2: Q1 Dependency</h4>
                    <p style="color:#94a3b8;font-size:0.9rem;">When <code>suppress_price_break_if_Q1_not_updated</code> is enabled:</p>
                    <div class="formula">Q2+ only valid if Q1 has CHANGE result</div>
                    <p style="color:#64748b;font-size:0.85rem;margin-top:0.5rem;">Bypassed by slow cron. Q1 itself is always valid.</p>
                </div>
            </div>
        </section>

        <!-- Buy Box Rules -->
        <section id="buybox">
            <h2>Buy Box Competition Rules</h2>

            <h3>Shipping Buckets</h3>
            <div class="buybox-grid" style="margin-bottom:1.5rem;">
                <div class="buybox-card">
                    <h5>Bucket 1 (Fast)</h5>
                    <div class="formula">1-2 days handling</div>
                </div>
                <div class="buybox-card">
                    <h5>Bucket 2 (Standard)</h5>
                    <div class="formula">3-5 days handling</div>
                </div>
                <div class="buybox-card">
                    <h5>Bucket 3 (Slow)</h5>
                    <div class="formula">6+ days handling</div>
                </div>
            </div>

            <h3>Competition Rules (To Beat Competitor)</h3>
            <div class="buybox-grid">
                <div class="buybox-card">
                    <h5>Both Have Badge, Same Shipping</h5>
                    <div class="formula">ourPrice &le; theirPrice - $0.01</div>
                    <p class="formula-note">Standard penny undercut</p>
                </div>
                <div class="buybox-card">
                    <h5>Both Have Badge, We're Faster</h5>
                    <div class="formula">ourPrice &lt; theirPrice × 1.005</div>
                    <p class="formula-note">0.5% bonus for faster shipping</p>
                </div>
                <div class="buybox-card">
                    <h5>Both Have Badge, We're Slower</h5>
                    <div class="formula">ourPrice &lt; theirPrice × 0.995</div>
                    <p class="formula-note">Must be 0.5% cheaper to compensate</p>
                </div>
                <div class="buybox-card">
                    <h5>We Have Badge, They Don't</h5>
                    <div class="formula">ourPrice &lt; theirPrice × 1.10</div>
                    <p class="formula-note">10% premium for badge advantage</p>
                </div>
                <div class="buybox-card">
                    <h5>They Have Badge, We Don't</h5>
                    <div class="formula">ourPrice &lt; theirPrice × 0.90</div>
                    <p class="formula-note">Must be 10% cheaper without badge</p>
                </div>
                <div class="buybox-card">
                    <h5>Neither Has Badge</h5>
                    <div class="formula">Same shipping rules apply</div>
                    <p class="formula-note">Shipping speed differentiates</p>
                </div>
            </div>
        </section>

        <!-- Examples -->
        <section id="examples">
            <h2>Applied Examples</h2>

            <!-- Example 1 -->
            <div class="example">
                <div class="example-header">
                    <h4>Example 1: Simple UNIT Strategy - Price Down</h4>
                    <div class="example-result down">CHANGE_DOWN</div>
                </div>
                <div class="example-grid">
                    <div class="example-box">
                        <h5>Our Vendor (Frontier)</h5>
                        <div class="example-data">
                            <div><span class="label">Current Q1 Price</span><span class="value">$25.00</span></div>
                            <div><span class="label">Floor / Max</span><span class="value">$18.00 / $50.00</span></div>
                            <div><span class="label">price_strategy</span><span class="value">UNIT</span></div>
                            <div><span class="label">up_down</span><span class="value">UP_DOWN</span></div>
                        </div>
                    </div>
                    <div class="example-box">
                        <h5>Competition (After Filters)</h5>
                        <div class="example-data">
                            <div><span class="label">Competitor A</span><span class="value">$22.50</span></div>
                            <div><span class="label">Competitor B</span><span class="value">$23.00</span></div>
                            <div><span class="label">Competitor C</span><span class="value">$24.00</span></div>
                        </div>
                    </div>
                </div>
                <div class="flow-steps">
                    <div class="flow-step pass">Competition filters: 3 competitors remain</div>
                    <div class="flow-step calc">Price Strategy = UNIT → Sort by unit price</div>
                    <div class="flow-step calc">Target: Undercut A by $0.01 = <span class="hl">$22.49</span></div>
                    <div class="flow-step pass">Check: $22.49 &ge; floor($18.00) <span class="ok">YES</span></div>
                    <div class="flow-step pass">All 12 blocking rules <span class="ok">PASS</span></div>
                    <div class="flow-step result">suggestedPrice($22.49) &lt; existing($25.00) → <span class="hl">CHANGE_DOWN</span></div>
                </div>
            </div>

            <!-- Example 2 -->
            <div class="example">
                <div class="example-header">
                    <h4>Example 2: BUY_BOX Strategy - Badge Advantage</h4>
                    <div class="example-result up">CHANGE_UP</div>
                </div>
                <div class="example-grid">
                    <div class="example-box">
                        <h5>Our Vendor (MVP)</h5>
                        <div class="example-data">
                            <div><span class="label">Current Q1 Price</span><span class="value">$45.00</span></div>
                            <div><span class="label">Floor / Max</span><span class="value">$35.00 / $80.00</span></div>
                            <div><span class="label">price_strategy</span><span class="value">BUY_BOX</span></div>
                            <div><span class="label">Badge</span><span class="value">Yes (ID: 3)</span></div>
                            <div><span class="label">Shipping Time</span><span class="value">2 days</span></div>
                        </div>
                    </div>
                    <div class="example-box">
                        <h5>Competition</h5>
                        <div class="example-data">
                            <div><span class="label">Competitor A (No Badge)</span><span class="value">$42.00 + $8 = $50</span></div>
                            <div><span class="label">Competitor B (No Badge)</span><span class="value">$44.00 + $7 = $51</span></div>
                        </div>
                        <p style="font-size:0.8rem;color:#64748b;margin-top:0.5rem;">We have badge, they don't = 10% premium</p>
                    </div>
                </div>
                <div class="flow-steps">
                    <div class="flow-step calc">Price Strategy = BUY_BOX</div>
                    <div class="flow-step calc">Competitor A total: $50.00</div>
                    <div class="flow-step calc">Buy Box Rule: We have badge, they don't</div>
                    <div class="flow-step calc">Formula: ourPrice &lt; $50 × 1.10 = <span class="hl">$55.00</span></div>
                    <div class="flow-step calc">Target total: $54.99 → Unit price = <span class="hl">$54.99</span></div>
                    <div class="flow-step pass">All 12 blocking rules <span class="ok">PASS</span></div>
                    <div class="flow-step result">suggestedPrice($54.99) > existing($45.00) → <span class="hl">CHANGE_UP</span></div>
                </div>
            </div>

            <!-- Example 3 -->
            <div class="example">
                <div class="example-header">
                    <h4>Example 3: Blocked - Sister Already Winning</h4>
                    <div class="example-result ignore">IGNORE_SISTER_LOWEST</div>
                </div>
                <div class="example-grid">
                    <div class="example-box">
                        <h5>Our Vendor (Tradent)</h5>
                        <div class="example-data">
                            <div><span class="label">Current Q1 Price</span><span class="value">$30.00</span></div>
                            <div><span class="label">Calculated Best</span><span class="value">$24.99</span></div>
                            <div><span class="label">compete_with_all_vendors</span><span class="value">OFF</span></div>
                        </div>
                    </div>
                    <div class="example-box">
                        <h5>Market State</h5>
                        <div class="example-data">
                            <div><span class="label">Frontier (Sister) @ $25.00</span><span class="value" style="color:#10b981;">Buy Box #1</span></div>
                            <div><span class="label">Competitor A @ $27.00</span><span class="value">Position #2</span></div>
                            <div><span class="label">Tradent (Us) @ $30.00</span><span class="value">Position #3</span></div>
                        </div>
                    </div>
                </div>
                <div class="flow-steps">
                    <div class="flow-step calc">Calculated best price = $24.99</div>
                    <div class="flow-step pass">Rule 1-3: <span class="ok">PASS</span></div>
                    <div class="flow-step fail">Rule 4: Sister in BuyBox - <span class="err">BLOCKED</span></div>
                    <div class="flow-step calc">→ Frontier (20722) has buyBoxRank = 0</div>
                    <div class="flow-step calc">→ Frontier is own vendor + compete_with_all_vendors = OFF</div>
                    <div class="flow-step result">Result: <span class="err">IGNORE_SISTER_LOWEST</span></div>
                </div>
            </div>

            <!-- Example 4 -->
            <div class="example">
                <div class="example-header">
                    <h4>Example 4: Floor Hit - Compete with Next</h4>
                    <div class="example-result down">CHANGE_DOWN (to undercut next)</div>
                </div>
                <div class="example-grid">
                    <div class="example-box">
                        <h5>Our Vendor (FirstDent)</h5>
                        <div class="example-data">
                            <div><span class="label">Current Q1 Price</span><span class="value">$40.00</span></div>
                            <div><span class="label">Floor Price</span><span class="value">$30.00</span></div>
                            <div><span class="label">floor_compete_with_next</span><span class="value">ON</span></div>
                        </div>
                    </div>
                    <div class="example-box">
                        <h5>Competition</h5>
                        <div class="example-data">
                            <div><span class="label">Competitor A</span><span class="value" style="color:#ef4444;">$25.00 (below floor!)</span></div>
                            <div><span class="label">Competitor B</span><span class="value" style="color:#ef4444;">$28.00 (below floor!)</span></div>
                            <div><span class="label">Competitor C</span><span class="value">$35.00</span></div>
                        </div>
                    </div>
                </div>
                <div class="flow-steps">
                    <div class="flow-step calc">Try A: $24.99 &ge; floor($30)? <span class="err">NO - Skip</span></div>
                    <div class="flow-step calc">Try B: $27.99 &ge; floor($30)? <span class="err">NO - Skip</span></div>
                    <div class="flow-step calc">Try C: $34.99 &ge; floor($30)? <span class="ok">YES</span></div>
                    <div class="flow-step pass">Best price = <span class="hl">$34.99</span></div>
                    <div class="flow-step pass">All 12 blocking rules <span class="ok">PASS</span></div>
                    <div class="flow-step result">suggestedPrice($34.99) &lt; existing($40.00) → <span class="hl">CHANGE_DOWN</span></div>
                </div>
            </div>

            <!-- Example 5 -->
            <div class="example">
                <div class="example-header">
                    <h4>Example 5: Q-Break Validation - Hierarchy Invalid</h4>
                    <div class="example-result ignore">Q2: IGNORE_SETTINGS (UNNECESSARY)</div>
                </div>
                <div class="example-grid">
                    <div class="example-box">
                        <h5>Calculated Solutions (TopDent)</h5>
                        <div class="example-data">
                            <div><span class="label">Q1 Solution</span><span class="value">$15.00 → CHANGE_DOWN</span></div>
                            <div><span class="label">Q2 Solution</span><span class="value" style="color:#f59e0b;">$15.00 → ???</span></div>
                            <div><span class="label">Q5 Solution</span><span class="value">$14.00 → CHANGE_DOWN</span></div>
                        </div>
                    </div>
                    <div class="example-box">
                        <h5>Q-Break Hierarchy Rule</h5>
                        <p style="font-size:0.9rem;color:#94a3b8;">Higher quantities must have <strong>lower prices</strong> than lower quantities.</p>
                        <p style="font-size:0.85rem;color:#64748b;margin-top:0.5rem;">Q2 at $15.00 = Q1 at $15.00 → No discount benefit → UNNECESSARY</p>
                    </div>
                </div>
                <div class="flow-steps">
                    <div class="flow-step pass">All 12 blocking rules passed for Q1, Q2, Q5</div>
                    <div class="flow-step calc">Q-Break Validation: getInvalidQuantityBreaks()</div>
                    <div class="flow-step pass">Q1 ($15.00): Always valid</div>
                    <div class="flow-step fail">Q2 ($15.00): Q1 price ($15) &le; Q2 price ($15)? <span class="err">YES - INVALID</span></div>
                    <div class="flow-step pass">Q5 ($14.00): Q1 price ($15) > Q5 price ($14)? <span class="ok">VALID</span></div>
                    <div class="flow-step result">Q2: qBreakValid = false → <span class="err">IGNORE_SETTINGS</span></div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p>V2 Repricer Algorithm Flowchart | Validated: 2025-11-25</p>
        <p>Source: <code>apps/api-core/src/utility/reprice-algo/v2/</code></p>
        <p>Files: algorithm.ts (1646 lines), settings.ts (263 lines), types.ts (72 lines), utility.ts (150 lines), wrapper.ts (465 lines)</p>
    </footer>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#fff',
                primaryBorderColor: '#60a5fa',
                lineColor: '#94a3b8',
                secondaryColor: '#8b5cf6',
                tertiaryColor: '#1e293b',
                background: '#0f172a',
                mainBkg: '#1e293b',
                nodeBorder: '#475569',
                clusterBkg: '#1e293b',
                clusterBorder: '#334155',
                titleColor: '#fff',
                edgeLabelBackground: '#1e293b'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 15
            }
        });
    </script>
</body>
</html>
